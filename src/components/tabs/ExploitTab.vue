<script setup lang="ts">
import {
  VisibilityFilled,
  VisibilityOffFilled,
} from '@vicons/material'
import JobSpan from '../ui/JobSpan.vue'
import useCombatParser from '@/composables/useCombatParser'
import { formatTime } from '@/tools'
import type { DeathInfo } from '@/types/combat'

const NAIVE_UI_MESSAGE = useMessage()
const {
  combatData,
  knockouts, deaths,
} = useCombatParser()

const hidePlayerName = ref(false)
const insideTabs = computed(() => [
  [ 'knockouts', '击倒', knockouts.value ],
  [ 'deaths', '阵亡', deaths.value ],
] as [string, string, DeathInfo[]][])
const activeTab = ref(insideTabs.value![0]![0])

const currDeaths = computed(() => insideTabs.value!.find(tab => tab[0] === activeTab.value)![2])

const getDeathDamage = (death: DeathInfo) => {
  if (death.lasthitActionInstantDeath) {
    return '即死'
  }
  return death.lasthitActionDamage.toLocaleString()
}

const switchShowPlayerNameButtonActionText = computed(() => hidePlayerName.value ? '显示' : '隐藏')
const handleSwitchShowPlayerName = () => {
  const act = switchShowPlayerNameButtonActionText.value
  hidePlayerName.value = !hidePlayerName.value
  NAIVE_UI_MESSAGE.info(`已${act}玩家名称`)
}
</script>

<template>
  <div class="page-panel min-h-0">
    <div class="w-full flex items-center gap-1 shrink-0">
      <div
        v-for="tab in insideTabs"
        :key="tab[0]"
        class="text-[1.2rem] leading-[1] px-2 py-1 border border-transparent rounded text-white cursor-pointer text-shadow
          transition-colors duration-200"
        :class="activeTab === tab[0] ? 'bg-white/30' : 'hover:bg-white/30'"
        @click="activeTab = tab[0]"
      >
        {{ tab[1] }}
      </div>
    </div>
    <n-divider class="!my-1 shrink-0"></n-divider>
    <div class="w-full flex flex-col gap-0.5 flex-1 min-h-0 overflow-y-auto">
      <div v-if="!currDeaths.length" class="page-title">暂无数据</div>
      <AlertTitle v-else-if="!combatData.zone && !combatData.onConflict" msg="此处展示的是上一场的记录，下次进入对战时会被清除。" />
      <div
        v-for="(death, deathIndex) in currDeaths"
        :key="`${activeTab}-${deathIndex}`"
        class="page-title"
      >
        <div>{{ formatTime(death.happenTime) }}　</div>
        <div class="flex flex-wrap flex-1">
          <template v-if="activeTab === 'knockouts'">
            <span>使用</span>
            <template v-if="death.summonedBy">
              <span class="text-orange-700">{{ death.perpetratorName }}</span>
              <span>发动的</span>
            </template>
            <span class="text-orange-700">{{ death.lasthitActionName }}</span>
            <span>造成了</span>
            <span class="text-orange-700">{{ getDeathDamage(death) }}</span>
            <span>伤害，击倒了</span>
            <div class="flex items-center">
              <JobSpan v-if="death.victimJob" :job="death.victimJob" />
              <span class="text-orange-700" :class="hidePlayerName ? 'blur' : ''">{{ death.victimName }}</span>
            </div>
          </template>
          <template v-else-if="activeTab === 'deaths'">
            <span>被</span>
            <div class="flex items-center">
              <JobSpan v-if="death.perpetratorJob" :job="death.perpetratorJob" />
              <span class="text-orange-700" :class="hidePlayerName ? 'blur' : ''">
                {{ death.summonedBy || death.perpetratorName }}
              </span>
            </div>
            <template v-if="death.summonedBy">
              <span>召唤的</span>
              <span class="text-orange-700">{{ death.perpetratorName }}</span>
            </template>
            <span>用</span>
            <span class="text-orange-700">{{ death.lasthitActionName }}</span>
            <span>造成了</span>
            <span class="text-orange-700">{{ getDeathDamage(death) }}</span>
            <span>伤害，因此阵亡</span>
          </template>
        </div>
      </div>
    </div>

    <n-tooltip trigger="hover" placement="left">
      <template #trigger>
        <n-float-button
          type="primary"
          bottom="1rem" right="1rem"
          @click="handleSwitchShowPlayerName"
        >
          <n-icon>
            <VisibilityFilled v-if="hidePlayerName" />
            <VisibilityOffFilled v-else />
          </n-icon>
        </n-float-button>
      </template>
      <div class="text-[1.2rem]">{{ switchShowPlayerNameButtonActionText }}玩家名称</div>
    </n-tooltip>
  </div>
</template>

<style scoped>
</style>
